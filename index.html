<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluetooth Device Explorer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="max-w-md w-full mx-4">
    <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
      <h1 class="text-2xl font-bold text-center text-gray-800">Bluetooth Device Explorer</h1>

      <!-- Device Info -->
      <div id="deviceInfo" class="text-center text-sm text-gray-600 hidden">
        <div>Connected to: <span id="deviceName" class="font-semibold">Unknown</span></div>
        <div>Device ID: <span id="deviceId" class="font-mono text-xs">Unknown</span></div>
      </div>

      <!-- Status display -->
      <div id="statusDisplay" class="text-center text-gray-600">
        Ready to connect
      </div>

      <!-- Connect Button -->
      <button id="connectBtn"
        class="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
        Connect Device
      </button>

      <!-- Error Display -->
      <div id="errorDisplay" class="hidden text-red-500 text-center text-sm"></div>

      <!-- Available Services -->
      <div id="servicesDisplay" class="hidden">
        <div class="font-semibold mb-2 text-gray-700">Available Services:</div>
        <div id="servicesList" class="space-y-3 text-sm"></div>
      </div>

      <!-- Characteristics -->
      <div id="characteristicsDisplay" class="hidden">
        <div class="font-semibold mb-2 text-gray-700">Characteristics:</div>
        <div id="characteristicsList" class="space-y-2 text-sm"></div>
      </div>
    </div>
  </div>

  <script>
    const statusDisplay = document.getElementById('statusDisplay');
    const connectBtn = document.getElementById('connectBtn');
    const errorDisplay = document.getElementById('errorDisplay');
    const deviceInfo = document.getElementById('deviceInfo');
    const deviceName = document.getElementById('deviceName');
    const deviceId = document.getElementById('deviceId');
    const servicesDisplay = document.getElementById('servicesDisplay');
    const servicesList = document.getElementById('servicesList');
    const characteristicsDisplay = document.getElementById('characteristicsDisplay');
    const characteristicsList = document.getElementById('characteristicsList');

    // Known service UUIDs
    const SERVICE_NAMES = {
      '00001800-0000-1000-8000-00805f9b34fb': 'Generic Access',
      '00001801-0000-1000-8000-00805f9b34fb': 'Generic Attribute',
      '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information',
      '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
      '00001812-0000-1000-8000-00805f9b34fb': 'HID Service',
    };

    // Check if Web Bluetooth API is supported
    if (!navigator.bluetooth) {
      statusDisplay.textContent = 'Web Bluetooth API is not supported in this browser';
      connectBtn.disabled = true;
      connectBtn.classList.add('bg-gray-400');
      connectBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    }

    connectBtn.addEventListener('click', async () => {
      try {
        // Reset displays
        errorDisplay.classList.add('hidden');
        servicesDisplay.classList.add('hidden');
        characteristicsDisplay.classList.add('hidden');
        statusDisplay.textContent = 'Requesting Bluetooth device...';

        // Request device with optional services
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [
            '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
            '00001801-0000-1000-8000-00805f9b34fb', // Generic Attribute
            '0000180a-0000-1000-8000-00805f9b34fb', // Device Information
            '0000180f-0000-1000-8000-00805f9b34fb', // Battery
            '00001812-0000-1000-8000-00805f9b34fb'  // HID
          ]
        });

        // Update device info
        deviceName.textContent = device.name || 'Unknown Device';
        deviceId.textContent = device.id;
        deviceInfo.classList.remove('hidden');

        statusDisplay.textContent = 'Connecting to device...';
        const server = await device.gatt.connect();

        // Display available services
        statusDisplay.textContent = 'Discovering services...';
        const services = await server.getPrimaryServices();
        servicesDisplay.classList.remove('hidden');
        servicesList.innerHTML = '';

        // Process each service
        for (const service of services) {
          const serviceDiv = document.createElement('div');
          serviceDiv.className = 'p-2 bg-gray-50 rounded';

          const serviceName = SERVICE_NAMES[service.uuid] || 'Unknown Service';
          serviceDiv.innerHTML = `
                        <div class="font-semibold">${serviceName}</div>
                        <div class="text-xs font-mono text-gray-500">${service.uuid}</div>
                    `;

          // Try to get characteristics
          try {
            const characteristics = await service.getCharacteristics();
            if (characteristics.length > 0) {
              const charList = document.createElement('div');
              charList.className = 'mt-2 ml-4 space-y-1';

              for (const char of characteristics) {
                const charDiv = document.createElement('div');
                charDiv.className = 'text-xs';
                charDiv.innerHTML = `
                                    <div>Characteristic: ${char.uuid}</div>
                                    <div class="text-gray-500">Properties: ${Object.keys(char.properties).filter(p => char.properties[p]).join(', ')}</div>
                                `;
                charList.appendChild(charDiv);
              }
              serviceDiv.appendChild(charList);
            }
          } catch (e) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-xs text-red-500 mt-1';
            errorDiv.textContent = `Could not read characteristics: ${e.message}`;
            serviceDiv.appendChild(errorDiv);
          }

          servicesList.appendChild(serviceDiv);
        }

        statusDisplay.textContent = 'Connected';
        connectBtn.textContent = 'Reconnect';

        // Handle device disconnection
        device.addEventListener('gattserverdisconnected', () => {
          statusDisplay.textContent = 'Device disconnected';
          deviceInfo.classList.add('hidden');
          servicesDisplay.classList.add('hidden');
          characteristicsDisplay.classList.add('hidden');
          connectBtn.textContent = 'Connect Device';
        });

      } catch (error) {
        handleError(error);
      }
    });

    function handleError(error) {
      console.error('Bluetooth Error:', error);
      errorDisplay.classList.remove('hidden');

      if (error.name === 'NotFoundError') {
        errorDisplay.textContent = 'No compatible Bluetooth device found.';
      } else if (error.name === 'SecurityError') {
        errorDisplay.textContent = 'Bluetooth permission denied. Please allow access and try again.';
      } else if (error.name === 'NotSupportedError') {
        errorDisplay.textContent = 'Bluetooth not supported or enabled on this device.';
      } else {
        errorDisplay.textContent = `Error: ${error.message}`;
      }

      statusDisplay.textContent = 'Connection failed';
      deviceInfo.classList.add('hidden');
    }
  </script>
</body>

</html>
